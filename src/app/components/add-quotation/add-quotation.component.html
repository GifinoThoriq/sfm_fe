<div>
    <div class="form-body">
        <form nz-form nzLayout="vertical" [formGroup]="quotationForm">

            <nz-tabset [nzAnimated]="false"  [(nzSelectedIndex)]="selectedTabIndex">
                <nz-tab nzTitle="Basic Information">
                    <div *ngIf="modal_type !== 'add'" class="row">
                        <div class="col-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="quotation_no" class="fw-semibold">Quotation No</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="quotation_no" id="quotation_no" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>
                    <div class="row">

                        <div class="col-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="revision" class="fw-semibold">Revision</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="revision" id="revision" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-4">
                            <nz-form-item class="mb-4">
                                <nz-form-label nzRequired nzFor="pic" class="fw-semibold">Prepared by</nz-form-label>
                                <nz-form-control>
                                    <ng-container *ngIf="!isLoadingPic; else loadPic">
                                        <nz-select nzShowSearch nzPlaceHolder="Select PIC" formControlName="prepared_by">
                                            <nz-option
                                            *ngFor="let p of listOfPic"
                                                [nzLabel]="p.name" 
                                                [nzValue]="p.pic_id"
                                            ></nz-option>
                                        </nz-select>
                                    </ng-container>
                                    <ng-template #loadPic>
                                        <nz-select nzShowSearch nzPlaceHolder="loading..." nzDisabled>
                                        </nz-select>
                                    </ng-template>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-6">
                            <nz-form-item>
                                <nz-form-label nzRequired class="fw-semibold" nzFor="project_id">Project ID</nz-form-label>
                                <nz-form-control>
                                    <ng-container *ngIf="projectsData.length > 0; else loadProject">
                                        <nz-select nzShowSearch nzPlaceHolder="Select Type" formControlName="project_id">
                                            <nz-option *ngFor="let project of projectsData" [nzLabel]="project.project_pid" [nzValue]="project.id"></nz-option>
                                        </nz-select>
                                    </ng-container>
                                    <ng-template #loadProject>
                                        <nz-select nzPlaceHolder="Loading" nzDisabled>
                                        </nz-select>
                                    </ng-template>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-6">
                            <nz-form-item>
                                <nz-form-label nzRequired class="fw-semibold" nzFor="project_name">Project Name</nz-form-label>
                                <nz-form-control>
                                    <ng-container *ngIf="projectsData.length > 0; else loadProject">
                                        <nz-select nzShowSearch nzPlaceHolder="Select Type" formControlName="project_name">
                                            <nz-option *ngFor="let project of projectsData" [nzLabel]="project.name" [nzValue]="project.id"></nz-option>
                                        </nz-select>
                                    </ng-container>
                                    <!-- <ng-template #loadProject>
                                        <nz-select nzPlaceHolder="Loading" nzDisabled>
                                        </nz-select>
                                    </ng-template> -->
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <!-- <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired class="fw-semibold" nzFor="project_id">Project File</nz-form-label>
                                <nz-form-control>
                                    <nz-upload
                                      [(nzFileList)]="fileList"
                                      [nzBeforeUpload]="beforeUpload"
                                      [nzShowUploadList]="true"
                                      [nzWithCredentials]="true"
                                      [nzShowButton]="fileList.length < 3"
                                      [nzSize]="5000"
                                      [nzRemove]="removeDocument"
                                    >
                                      <button nz-button>
                                        <i nz-icon nzType="upload"></i>
                                        <span>Click to Upload</span>
                                      </button>
                                    </nz-upload>
                                  </nz-form-control>
                            </nz-form-item>
                        </div> -->
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="location" class="fw-semibold">Project Location</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="location" id="location" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="date" class="fw-semibold">Date</nz-form-label>
                                <nz-form-control>
                                    <nz-date-picker class="w-100" formControlName="date" id="date" nzPlaceHolder="pick a date"></nz-date-picker>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>
                    
                    <nz-divider></nz-divider>
                    <div class="row">
                        <div class="col-md-4">
                            <nz-form-item class="mb-4">
                                <nz-form-label nzRequired nzFor="pic" class="fw-semibold">Engineer PIC</nz-form-label>
                                <nz-form-control>
                                    <ng-container *ngIf="pic$ | async as pic; else picLoad">
                                        <nz-select nzShowSearch nzMode="tags" nzPlaceHolder="Select PIC" formControlName="engineer_pic">
                                            <nz-option
                                            *ngFor="let p of pic"
                                                [nzLabel]="p.name" 
                                                [nzValue]="p.pic_id"
                                            ></nz-option>
                                        </nz-select>
                                    </ng-container>
                                    <ng-template #picLoad>
                                        <nz-select nzShowSearch nzMode="tags" nzPlaceHolder="Select PIC" nzDisabled>
                                            <nz-option></nz-option>
                                        </nz-select>
                                    </ng-template>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
        
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired class="fw-semibold" nzFor="engineer_pic_internal" nzRequired>Head of Engineer PIC</nz-form-label>
                                <nz-form-control>
                                    <nz-select nzShowSearch nzPlaceHolder="Select Head" formControlName="engineer_pic_internal">
                                    <ng-container *ngFor="let pic of filteredListOfPic">
                                    <nz-option [nzLabel]="pic.name" [nzValue]="pic.pic_id"></nz-option>
                                    </ng-container>
                                    </nz-select>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
        
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="engineer_phone_number" class="fw-semibold">Engineer Phone Number</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="engineer_phone_number" id="engineer_phone_number" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>
                    <h6 class="fw-bold my-4">Customer</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="customer" class="fw-semibold">Customer</nz-form-label>
                                <nz-form-control>
                                    <nz-select nzShowSearch nzPlaceHolder="Select Customer" formControlName="customer">
                                        <nz-option *ngFor="let cust of selectedCustomer" [nzLabel]="cust.customer.name" [nzValue]="cust.customer.id">
                                            
                                        </nz-option>
                                    </nz-select>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="customer_location" class="fw-semibold">Customer Location</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="customer_location" id="customer_location" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <!-- <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="consultant" class="fw-semibold">Consultant</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="consultant" id="consultant" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="consultant_location" class="fw-semibold">Consultant Location</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="consultant_location" id="consultant_location" />
                                </nz-form-control>
                            </nz-form-item>
                        </div> -->
                    </div>
                    <h6 class="fw-bold mb-4">Contact Person</h6>
                    <div class="row">
                        <div class="col-md-4 fw-bold">Name</div>
                        <div class="col-md-4 fw-bold">Role</div>
                        <div class="col-md-4 fw-bold">Attention</div>
                    </div>
                    <ng-container formArrayName="contactPerson">
                        <ng-container *ngFor="let cp of contactPersons.controls; let i = index" [formGroupName]="i">
                            <div class="row mt-4">
                                <div class="col-md-4">
                                    <nz-form-control>
                                        <input nz-input formControlName="name" id="name" />
                                    </nz-form-control>
                                </div>
                                <div class="col-md-4">
                                    <nz-form-control>
                                        <input nz-input formControlName="role" id="role" />
                                    </nz-form-control>
                                </div>
                                <div class="col-md-4">
                                    <nz-form-control>
                                        <label nz-checkbox formControlName="attention" id="attention"></label>
                                    </nz-form-control>
                                </div>
                            </div>
                        </ng-container>
                    </ng-container>
                </nz-tab>
                <nz-tab nzTitle="Stack">
                    <div class="table-responsive">
                        <table class="table table-striped table-order table-purchase">
                            <thead style="position: unset">
                                <tr>
                                    <th scope="col" style="width: 8%;">Stack Name</th>
                                    <th scope="col">BOM Quotation PDF</th>
                                    <th scope="col" style="width: 8%;">Revision Quotation</th>
                                    <th scope="col" style="width: 8%;">BOM Contract(RO)</th>
                                    <th scope="col">BOM Contract Revision PDF</th>
                                    <th scope="col" style="width: 8%;">Revision Contract</th>
                                    <th scope="col">Detail</th>
                                    <th scope="col">Used for Total Quotation</th>
                                    <th scope="col">Active</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <ng-container formArrayName="stacks">
                                    <tr *ngFor="let stack of stacks.controls; let i = index" [formGroupName]="i">
                                        <td>
                                            <nz-form-control>
                                                <input nz-input formControlName="name"/>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <nz-upload
                                                [nzBeforeUpload]="beforeUploadStacks(i)"
                                                [nzFileList]="stack.get('stack_file')?.value"
                                                [nzShowUploadList]="true"
                                                [nzWithCredentials]="true"
                                                [nzLimit]="1"
                                                [nzSize]="1000"
                                                [nzRemove]="handleRemoveAttachmentStacks(i)"
                                              >
                                                <button nz-button>
                                                  <i nz-icon nzType="upload"></i>
                                                  <span>Click to Upload</span>
                                                </button>
                                              </nz-upload>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <input nz-input formControlName="revision_stack"/>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <input nz-input formControlName="revision_bom_contract"/>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <nz-upload
                                                [nzBeforeUpload]="beforeUploadStacksContract(i)"
                                                [nzFileList]="stack.get('stack_file_contract')?.value"
                                                [nzShowUploadList]="true"
                                                [nzWithCredentials]="true"
                                                [nzLimit]="1"
                                                [nzSize]="1000"
                                                [nzRemove]="handleRemoveAttachmentStacksContract(i)"
                                              >
                                                <button nz-button>
                                                  <i nz-icon nzType="upload"></i>
                                                  <span>Click to Upload</span>
                                                </button>
                                              </nz-upload>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <input nz-input formControlName="revision_contract"/>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <button (click)="openStackDetail(i)" nz-button nzType="default">Open Detail</button>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <label nz-checkbox formControlName="is_total_quotation"></label>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <label nz-checkbox formControlName="active"></label>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <div class="d-flex gap-3">
                                                <a nz-dropdown nzTrigger="click" [nzDropdownMenu]="menu" style="text-decoration: none;" >
                                                    <div class="d-flex align-items-center">
                                                      <i nz-icon nzType="more" nzTheme="outline"></i>
                                                      <p class="m-0 p-0">More</p>                       
                                                    </div>
                                                </a>
                                                <nz-dropdown-menu  #menu="nzDropdownMenu">
                                                    <ul nz-menu class="dropdown-wrapper" style="width: 120px;">
                                                        <ng-container *ngIf="!stack.get('new')?.value">
                                                            <li nz-menu-item class="gap-2 list-dropdown"  (click)="editStack('edit', i)">
                                                            <div class="d-flex gap-2">
                                                              <span nz-icon nzType="edit" nzTheme="twotone"></span>
                                                              <p class="m-0 p-0">Edit</p>
                                                            </div>
                                                          </li>
                                                          <li nz-menu-item class="gap-2 list-dropdown"  (click)="editStack('revision', i)">
                                                            <div class="d-flex gap-2">
                                                              <span nz-icon nzType="diff" nzTheme="twotone"></span>
                                                              <p class="m-0 p-0">Revision</p>
                                                            </div>
                                                          </li>
                                                        </ng-container>
                                                        <li nz-menu-item class="gap-2 list-dropdown" (click)="removeStacks(i)">
                                                            <div class="d-flex gap-2">
                                                                <span nz-icon nzType="delete" nzTheme="twotone" [nzTwotoneColor]="'#f50'"></span>
                                                                <p class="m-0 p-0" style="color: #f50;">Delete</p>  
                                                            </div>
                                                        </li>
                                                    </ul>
                                                </nz-dropdown-menu>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <ng-container *ngIf="modal_type === 'edit';else hideQuotationTotal">
                                            <td colspan="5" class="text-center">
                                                <button (click)="addStacks()" nz-button nzType="primary" class="w-75">Add Stack</button>
                                            </td>
                                            <td colspan="5" class="text-center">
                                                <button (click)="createQuotationTotal()" nz-button nzType="default" class="w-75">
                                                    {{ dataQuotation.project.project_category === 'cat_awared' ? 'Create Contract Revision' : 'Create Quotation Total' }}
                                                </button>
                                            </td>
                                        </ng-container>
                                        <ng-template #hideQuotationTotal>
                                            <td colspan="10" class="text-center">
                                                <button (click)="addStacks()" nz-button nzType="primary" class="w-75">Add Stack</button>
                                            </td>
                                        </ng-template>
                                    </tr>
                                </ng-container>
                            </tbody>
                        </table>
                    </div>
                </nz-tab>
                <nz-tab *ngIf="this.isCreateQuotationTotal" nzTitle="Quotation">
                    <div class="row p-3">
                        <p class="m-0 p-0 fw-bold col-12">Stacks</p>
                        <div class="col-12">
                            <p class="m-0 p-0 text-uppercase">
                                <ng-container *ngFor='let s of selectedStack; let isLast = last'>
                                    {{ s }} {{ isLast ? '' : ', ' }}
                                </ng-container>
                            </p>
                        </div>
                    </div>
                    <nz-tabset [nzAnimated]="false">
                        <nz-tab nzTitle="Material">
                            <div class="table-responsive">
                                <table class="table table-order table-purchase">
                                    <thead style="position: unset;">
                                        <tr>
                                            <th scope="col">Part Number</th>
                                            <th scope="col">Product Description</th>
                                            <th scope="col">Alias</th>
                                            <th scope="col">DN</th>
                                            <th scope="col">DN</th>
                                            <th scope="col">Qty</th>
                                            <th scope="col">Unit</th>
                                            <th scope="col">Unit Price</th>
                                            <th scope="col">Total Cost</th>
                                            <th scope="col">Gross Margin</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <ng-container formArrayName="items">
                                            <ng-container *ngFor="let category of objectKeys(groupedItems)">
                                                <tr>
                                                    <td class="" colspan="10">
                                                        <span class="fw-bold">{{category}}</span>
                                                    </td>
                                                </tr>

                                                <tr *ngIf="groupedItems[category].items.length > 0">
                                                    <td class="" colspan="10">
                                                        <div class="d-flex flex-column gap-2">
                                                            <span class="fw-bold">Discount</span>
                                                            <nz-input-number-group class="w-25" nzAddOnAfter="%">
                                                                <nz-input-number [nzMin]="0" [formControl]="groupedItems[category].discount"></nz-input-number>
                                                            </nz-input-number-group>
                                                        </div>
                                                    </td>
                                                </tr>
        
                                                <ng-container>
                                                    <tr *ngFor="let item of groupedItems[category].items; let i = index" [formGroup]="item">
                                                        <td>                                                            
                                                            {{ item.get('exist')?.value 
                                                                ? getCodeById(item.get('part_number')?.value)
                                                                : item.get('part_number')?.value
                                                            }}
                                                            <br />
                                                            <nz-alert
                                                                *ngIf="!item.get('exist')?.value"
                                                                nzType="error"
                                                                nzMessage="Item not registered yet in inventory"
                                                            ></nz-alert>
                                                        </td>
                                                        <td>
                                                            {{ item.get('exist')?.value 
                                                                ? getDescById(item.get('part_number')?.value)
                                                                : item.get('part_number')?.value
                                                            }}
                                                            <br />
                                                            <nz-alert
                                                                *ngIf="!item.get('exist')?.value"
                                                                nzType="error"
                                                                nzMessage="Item not registered yet in inventory"
                                                            ></nz-alert>
                                                        </td>
                                                        <td>
                                                            {{ item.get('alias')?.value }}
                                                            <!-- <nz-form-control>
                                                                <input nz-input formControlName="alias" />
                                                            </nz-form-control> -->
                                                        </td>
                                                        <td>
                                                            {{ item.get('dn1')?.value }}
                                                            <!-- <nz-form-control>
                                                                <input nz-input formControlName="dn1" id="dn1" />
                                                            </nz-form-control> -->
                                                        </td>
                                                        <td>
                                                            {{ item.get('dn2')?.value }}
                                                            <!-- <nz-form-control>
                                                                <input nz-input formControlName="dn2" id="dn2" />
                                                            </nz-form-control> -->
                                                        </td>
                                                        <td>
                                                            {{ item.get('qty')?.value }}
                                                            <!-- <nz-form-control>
                                                                <input nz-input formControlName="qty" id="qty" />
                                                            </nz-form-control> -->
                                                        </td>
                                                        <td>
                                                            {{ item.get('unit')?.value }}
                                                            <!-- <nz-form-control>
                                                                <input nz-input formControlName="unit" id="unit" />
                                                            </nz-form-control> -->
                                                        </td>
                                                        <td>
                                                            Rp {{ item.get('unit_price')?.value | number:'1.0-0' }}
                                                        </td>
                                                        <td>
                                                            Rp. {{ item.get('total_price')?.value | number:'1.0-0' }}
                                                        </td>
                                                        <td>
                                                            {{ item.get('gross_margin')?.value }} %
                                                        </td>
                                                    </tr>
                                                </ng-container>
                                            </ng-container>
                                        </ng-container>


                                        <tr>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td>
                                                <span class="fw-bold">Total Grand Cost:</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold"> Rp.  {{ totalGrandCost | number:'1.0-0' }}</span>
                                            </td>
                                            <td></td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <!-- <nz-divider></nz-divider>
                                <div class="my-4 d-flex gap-2 w-100 justify-content-end">
                                    <span class="fw-bold">Total Grand Cost:</span>
                                    <span class="fw-bold"> Rp.  {{ totalGrandCost | number:'1.0-0' }}</span>
                                </div> -->
                            </div>
                        </nz-tab>
                        <nz-tab nzTitle="Installation">

                            <ng-container foormArrayName="items">
                                <ng-container *ngFor="let category of objectKeys(groupedItems)">
                                    <div class="table-responsive">
                                        <table class="table table-order table-installation">
                                            <thead style="position: unset;">
                                                <tr class="table-active">
                                                    <th scope="col" colSpan="8">{{ category }}</th>
                                                </tr>
                                                <tr class="table-active">
                                                    <th scope="col">Part Number</th>
                                                    <th scope="col">Product Description</th>
                                                    <th scope="col">Inch</th>
                                                    <th scope="col">
                                                        {{ category.toLowerCase() === 'pipe' ? 'Cost/M\'' : 'Cost/Unit'  }}
                                                    </th>
                                                    <th scope="col">
                                                        {{ category.toLowerCase() === 'pipe' ? 'Cost M\'/inch' : 'Cost Unit/Inch'  }}
                                                    </th>
                                                    <th scope="col">Price Factor</th>
                                                    <th scope="col">Selling Price</th>
                                                    <th scope="col">Gross Margin</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <ng-container>
                                                    <tr  *ngFor="let item of groupedItems[category].items; let i = index" [formGroup]="item">
                                                        <td>
                                                            {{ item.get('i_part_number')?.value }}
                                                        </td>
                                                        <td>
                                                            {{ item.get('i_description')?.value }}
                                                        </td>
                                                        <td>
                                                            <ng-container *ngIf="item.get('installation_unit_price_type')?.value === 'price'; else emptyUnitPrice">
                                                                <nz-input-number-group class="w-100">
                                                                    <nz-input-number class="w-100" [nzMin]="0" formControlName="installation_unit_inch_qty"></nz-input-number>
                                                                </nz-input-number-group>
                                                            </ng-container>
                                                            <ng-template #emptyUnitPrice>
                                                                -
                                                            </ng-template>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex flex-column">
                                                                <ng-container *ngIf="item.get('installation_unit_price_type')?.value === 'percent';else price">
                                                                    <nz-input-number-group nzAddOnAfter="%">
                                                                        <nz-input-number formControlName="installation_unit_price"></nz-input-number>
                                                                    </nz-input-number-group>
                                                                </ng-container>
                                                                <ng-template #price>
                                                                    <nz-input-number-group nzAddOnBefore="Rp. ">
                                                                        <nz-input-number     
                                                                        formControlName="installation_unit_price"
                                                                        [nzFormatter]="formatter"
                                                                        ></nz-input-number>
                                                                    </nz-input-number-group>
                                                                </ng-template>
                                                                <nz-radio-group formControlName="installation_unit_price_type" class="mt-2">
                                                                    <label nz-radio nzValue="percent">Percent</label>
                                                                    <label nz-radio nzValue="price">Price</label>
                                                                </nz-radio-group>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            Rp. {{ item.get('installation_price_per_unit')?.value | number:'1.0-0' }}
                                                        </td>
                                                        <td>
                                                            <nz-input-number-group class="w-100">
                                                                <nz-input-number class="w-100" [nzMin]="0" formControlName="installation_price_factor"></nz-input-number>
                                                            </nz-input-number-group>
                                                        </td>
                                                        <td>
                                                            Rp. {{ item.get('installation_selling_price')?.value | number:'1.0-0' }}
                                                        </td>
                                                        <td>
                                                            {{ item.get('installation_gross_margin')?.value }} %
                                                        </td>
                                                    </tr>
                                                </ng-container>
                                            </tbody>
                                        </table>
                                    </div>
                                </ng-container>
                            </ng-container>
                        </nz-tab>
                        <nz-tab nzTitle="Total">
                            <div class="table-responsive">
                                <table class="table table-order table-purchase">
                                    <thead style="position: unset">
                                        <tr>
                                            <th scope="col">Part Number</th>
                                            <th scope="col">Product Description</th>
                                            <th scope="col">Alias</th>
                                            <th scope="col">Qty</th>
                                            <th scope="col">Unit</th>
                                            <th scope="col">Unit Price</th>
                                            <th scope="col">Total Cost</th>
                                            <th scope="col">Gross Margin</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="table-secondary">
                                            <td colspan="8">
                                                <span class="fw-bold" style="font-size: 16px;">
                                                    Material
                                                </span>
                                            </td>
                                        </tr>
                                        <ng-container formArrayName="items">
                                            <ng-container *ngFor="let category of objectKeys(groupedItems)">
                                                <tr>
                                                    <td class="" [colSpan]="groupedItems[category].items.length > 0 ? '6' : '8'">
                                                        <span class="fw-bold">{{category}}</span>
                                                    </td>
                                                    <td *ngIf="groupedItems[category].items.length > 0" colspan="2">
                                                        <span class="fw-bold">
                                                            Rp. {{ groupedItems[category].totalPrice.value | number:'1.0-0' }}
                                                        </span>
                                                    </td>
                                                </tr>
                                                

                                                <tr *ngFor="let item of groupedItems[category].items; let i = index" [formGroup]="item">
                                                    <td>                                                            
                                                        {{ item.get('exist')?.value 
                                                            ? getCodeById(item.get('part_number')?.value)
                                                            : item.get('part_number')?.value
                                                        }}
                                                        <br />
                                                        <nz-alert
                                                            *ngIf="!item.get('exist')?.value"
                                                            nzType="error"
                                                            nzMessage="Item not registered yet in inventory"
                                                        ></nz-alert>
                                                    </td>
                                                    <td>
                                                        {{ item.get('exist')?.value 
                                                            ? getDescById(item.get('part_number')?.value)
                                                            : item.get('part_number')?.value
                                                        }}
                                                        <br />
                                                        <nz-alert
                                                            *ngIf="!item.get('exist')?.value"
                                                            nzType="error"
                                                            nzMessage="Item not registered yet in inventory"
                                                        ></nz-alert>
                                                    </td>
                                                    <td>
                                                        {{ item.get('alias')?.value }}
                                                    </td>
                                                    <td>
                                                        {{ item.get('unit')?.value }}
                                                    </td>
                                                    <td>
                                                        {{ item.get('qty')?.value }}
                                                    </td>
                                                    <td>
                                                        Rp {{ item.get('unit_price')?.value | number:'1.0-0' }}
                                                    </td>
                                                    <td>
                                                        Rp. {{ item.get('total_price')?.value | number:'1.0-0' }}
                                                    </td>
                                                    <td>
                                                        {{ item.get('gross_margin')?.value }} %
                                                    </td>
                                                </tr>
                                            </ng-container>
                                        </ng-container>

                                        <tr class="table-secondary">
                                            <td colSpan="8">
                                                <span class="fw-bold" style="font-size: 16px;">
                                                    Material Installation
                                                </span>
                                            </td>
                                        </tr>

                                        <ng-container formArrayName="items">
                                            <ng-container *ngFor="let category of objectKeys(groupedItems)">
                                                <tr>
                                                    <td colspan="8" class="fw-bold">{{ category }}</td>
                                                </tr>
                                                <tr *ngFor="let item of groupedItems[category].items; let i = index" [formGroup]="item">
                                                    <td>
                                                        {{ item.get('i_part_number')?.value }}
                                                    </td>
                                                    <td>
                                                        {{ item.get('i_description')?.value }}
                                                    </td>
                                                    <td>
                                                        {{ item.get('alias')?.value }}
                                                    </td>
                                                    <td>-</td>
                                                    <td>-</td>
                                                    <td>-</td>
                                                    <td>-</td>
                                                    <td>-</td>
                                                </tr>
                                            </ng-container>
                                        </ng-container>
                                    </tbody>
                                </table>
                            </div>
                        </nz-tab>
                    </nz-tabset>

                </nz-tab>


            </nz-tabset>
        </form>
    </div>
    <div class="footer">
        <div class="d-flex gap-2 justify-content-end">
            <button nz-button nzType="default" (click)="closeDrawer()">Cancel</button>
            <button nz-button nzType="primary" (click)="submit()">
                <ng-container *ngIf="modal_type === 'add'">Add Quotation</ng-container>
                <ng-container *ngIf="modal_type === 'edit'">Edit Quotation</ng-container>
                <ng-container *ngIf="modal_type === 'revision'">Revised Quotation</ng-container>
            </button>
        </div>
    </div>
</div>