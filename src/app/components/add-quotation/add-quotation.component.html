<div>
    <div class="form-body">
        <form nz-form nzLayout="vertical" [formGroup]="quotationForm">

            <nz-tabset [nzAnimated]="false"  [(nzSelectedIndex)]="selectedTabIndex">
                <nz-tab nzTitle="Basic Information">
                    <div *ngIf="modal_type !== 'add'" class="row">
                        <div class="col-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="quotation_no" class="fw-semibold">Quotation No</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="quotation_no" id="quotation_no" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>
                    <div class="row">

                        <div class="col-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="revision" class="fw-semibold">Revision</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="revision" id="revision" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-4">
                            <nz-form-item class="mb-4">
                                <nz-form-label nzRequired nzFor="pic" class="fw-semibold">Prepared by</nz-form-label>
                                <nz-form-control>
                                    <ng-container *ngIf="!isLoadingPic; else loadPic">
                                        <nz-select nzShowSearch nzPlaceHolder="Select PIC" formControlName="prepared_by">
                                            <nz-option
                                            *ngFor="let p of listOfPic"
                                                [nzLabel]="p.name" 
                                                [nzValue]="p.pic_id"
                                            ></nz-option>
                                        </nz-select>
                                    </ng-container>
                                    <ng-template #loadPic>
                                        <nz-select nzShowSearch nzPlaceHolder="loading..." nzDisabled>
                                        </nz-select>
                                    </ng-template>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-6">
                            <nz-form-item>
                                <nz-form-label nzRequired class="fw-semibold" nzFor="project_id">Project ID</nz-form-label>
                                <nz-form-control>
                                    <ng-container *ngIf="projectsData.length > 0; else loadProject">
                                        <nz-select nzShowSearch nzPlaceHolder="Select Type" formControlName="project_id">
                                            <nz-option *ngFor="let project of projectsData" [nzLabel]="project.project_pid" [nzValue]="project.id"></nz-option>
                                        </nz-select>
                                    </ng-container>
                                    <ng-template #loadProject>
                                        <nz-select nzPlaceHolder="Loading" nzDisabled>
                                        </nz-select>
                                    </ng-template>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-6">
                            <nz-form-item>
                                <nz-form-label nzRequired class="fw-semibold" nzFor="project_name">Project Name</nz-form-label>
                                <nz-form-control>
                                    <ng-container *ngIf="projectsData.length > 0; else loadProject">
                                        <nz-select nzShowSearch nzPlaceHolder="Select Type" formControlName="project_name">
                                            <nz-option *ngFor="let project of projectsData" [nzLabel]="project.name" [nzValue]="project.id"></nz-option>
                                        </nz-select>
                                    </ng-container>
                                    <!-- <ng-template #loadProject>
                                        <nz-select nzPlaceHolder="Loading" nzDisabled>
                                        </nz-select>
                                    </ng-template> -->
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <!-- <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired class="fw-semibold" nzFor="project_id">Project File</nz-form-label>
                                <nz-form-control>
                                    <nz-upload
                                      [(nzFileList)]="fileList"
                                      [nzBeforeUpload]="beforeUpload"
                                      [nzShowUploadList]="true"
                                      [nzWithCredentials]="true"
                                      [nzShowButton]="fileList.length < 3"
                                      [nzSize]="5000"
                                      [nzRemove]="removeDocument"
                                    >
                                      <button nz-button>
                                        <i nz-icon nzType="upload"></i>
                                        <span>Click to Upload</span>
                                      </button>
                                    </nz-upload>
                                  </nz-form-control>
                            </nz-form-item>
                        </div> -->
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="location" class="fw-semibold">Project Location</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="location" id="location" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="date" class="fw-semibold">Date</nz-form-label>
                                <nz-form-control>
                                    <nz-date-picker class="w-100" formControlName="date" id="date" nzPlaceHolder="pick a date"></nz-date-picker>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>
                    
                    <nz-divider></nz-divider>
                    <div class="row">
                        <div class="col-md-4">
                            <nz-form-item class="mb-4">
                                <nz-form-label nzRequired nzFor="pic" class="fw-semibold">Engineer PIC</nz-form-label>
                                <nz-form-control>
                                    <ng-container *ngIf="pic$ | async as pic; else picLoad">
                                        <nz-select nzShowSearch nzMode="tags" nzPlaceHolder="Select PIC" formControlName="engineer_pic">
                                            <nz-option
                                            *ngFor="let p of pic"
                                                [nzLabel]="p.name" 
                                                [nzValue]="p.pic_id"
                                            ></nz-option>
                                        </nz-select>
                                    </ng-container>
                                    <ng-template #picLoad>
                                        <nz-select nzShowSearch nzMode="tags" nzPlaceHolder="Select PIC" nzDisabled>
                                            <nz-option></nz-option>
                                        </nz-select>
                                    </ng-template>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
        
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired class="fw-semibold" nzFor="engineer_pic_internal" nzRequired>Head of Engineer PIC</nz-form-label>
                                <nz-form-control>
                                    <nz-select nzShowSearch nzPlaceHolder="Select Head" formControlName="engineer_pic_internal">
                                    <ng-container *ngFor="let pic of filteredListOfPic">
                                    <nz-option [nzLabel]="pic.name" [nzValue]="pic.pic_id"></nz-option>
                                    </ng-container>
                                    </nz-select>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
        
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="engineer_phone_number" class="fw-semibold">Engineer Phone Number</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="engineer_phone_number" id="engineer_phone_number" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>
                    <h6 class="fw-bold my-4">Customer</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="customer" class="fw-semibold">Customer</nz-form-label>
                                <nz-form-control>
                                    <nz-select nzShowSearch nzPlaceHolder="Select Customer" formControlName="customer">
                                        <nz-option *ngFor="let cust of selectedCustomer" [nzLabel]="cust.customer.name" [nzValue]="cust.customer.id">
                                            
                                        </nz-option>
                                    </nz-select>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="customer_location" class="fw-semibold">Customer Location</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="customer_location" id="customer_location" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <!-- <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="consultant" class="fw-semibold">Consultant</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="consultant" id="consultant" />
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="consultant_location" class="fw-semibold">Consultant Location</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="consultant_location" id="consultant_location" />
                                </nz-form-control>
                            </nz-form-item>
                        </div> -->
                    </div>
                    <h6 class="fw-bold mb-4">Contact Person</h6>
                    <div class="row">
                        <div class="col-md-4 fw-bold">Name</div>
                        <div class="col-md-4 fw-bold">Role</div>
                        <div class="col-md-4 fw-bold">Attention</div>
                    </div>
                    <ng-container formArrayName="contactPerson">
                        <ng-container *ngFor="let cp of contactPersons.controls; let i = index" [formGroupName]="i">
                            <div class="row mt-4">
                                <div class="col-md-4">
                                    <nz-form-control>
                                        <input nz-input formControlName="name" id="name" />
                                    </nz-form-control>
                                </div>
                                <div class="col-md-4">
                                    <nz-form-control>
                                        <input nz-input formControlName="role" id="role" />
                                    </nz-form-control>
                                </div>
                                <div class="col-md-4">
                                    <nz-form-control>
                                        <label nz-checkbox formControlName="attention" id="attention"></label>
                                    </nz-form-control>
                                </div>
                            </div>
                        </ng-container>
                    </ng-container>
                </nz-tab>
                <nz-tab nzTitle="Stack">
                    <div class="">
                        <table class="table table-striped table-stack">
                            <thead style="position: unset">
                                <tr>
                                    <th scope="col" style="width: 8%;">Stack Name</th>
                                    <th scope="col">BOM Quotation PDF</th>
                                    <th scope="col" style="width: 8%;">Revision Quotation</th>
                                    <th scope="col" style="width: 8%;">BOM Contract(RO)</th>
                                    <th scope="col">BOM Contract Revision PDF</th>
                                    <th scope="col" style="width: 8%;">Revision Contract</th>
                                    <th scope="col">Detail</th>
                                    <th scope="col" *ngIf="modal_type !== 'add'">Used for Total Quotation</th>
                                    <th scope="col">Active</th>
                                    <th scope="col">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <ng-container formArrayName="stacks">
                                    <tr *ngFor="let stack of stacks.controls; let i = index" [formGroupName]="i">
                                        <td>
                                            <nz-form-control>
                                                <input nz-input formControlName="name"/>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <nz-upload
                                                [nzBeforeUpload]="beforeUploadStacks(i)"
                                                [nzFileList]="stack.get('stack_file')?.value"
                                                [nzShowUploadList]="true"
                                                [nzWithCredentials]="true"
                                                [nzLimit]="1"
                                                [nzSize]="1000"
                                                [nzRemove]="handleRemoveAttachmentStacks(i)"
                                              >
                                                <button nz-button>
                                                  <i nz-icon nzType="upload"></i>
                                                  <span>Click to Upload</span>
                                                </button>
                                              </nz-upload>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <input nz-input formControlName="revision_stack"/>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <input nz-input formControlName="revision_bom_contract"/>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <nz-upload
                                                [nzBeforeUpload]="beforeUploadStacksContract(i)"
                                                [nzFileList]="stack.get('stack_file_contract')?.value"
                                                [nzShowUploadList]="true"
                                                [nzWithCredentials]="true"
                                                [nzLimit]="1"
                                                [nzSize]="1000"
                                                [nzRemove]="handleRemoveAttachmentStacksContract(i)"
                                              >
                                                <button nz-button>
                                                  <i nz-icon nzType="upload"></i>
                                                  <span>Click to Upload</span>
                                                </button>
                                              </nz-upload>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <input nz-input formControlName="revision_contract"/>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <button (click)="openStackDetail(i)" nz-button nzType="default">Open Detail</button>
                                        </td>
                                        <td *ngIf="modal_type !== 'add'">
                                            <ng-container *ngIf="!stack.get('new')?.value">
                                                <nz-form-control>
                                                    <label nz-checkbox formControlName="is_total_quotation"></label>
                                                </nz-form-control>
                                            </ng-container>
                                        </td>
                                        <td>
                                            <nz-form-control>
                                                <label nz-checkbox formControlName="active"></label>
                                            </nz-form-control>
                                        </td>
                                        <td>
                                            <div class="d-flex gap-3">
                                                <a nz-dropdown nzTrigger="click" [nzDropdownMenu]="menu" style="text-decoration: none;" >
                                                    <div class="d-flex align-items-center">
                                                      <i nz-icon nzType="more" nzTheme="outline"></i>
                                                      <p class="m-0 p-0">More</p>                       
                                                    </div>
                                                </a>
                                                <nz-dropdown-menu  #menu="nzDropdownMenu">
                                                    <ul nz-menu class="dropdown-wrapper" style="width: 120px;">
                                                        <ng-container *ngIf="!stack.get('new')?.value">
                                                            <li nz-menu-item class="gap-2 list-dropdown"  (click)="editStack('edit', i)">
                                                            <div class="d-flex gap-2">
                                                              <span nz-icon nzType="edit" nzTheme="twotone"></span>
                                                              <p class="m-0 p-0">Edit</p>
                                                            </div>
                                                          </li>
                                                          <li nz-menu-item class="gap-2 list-dropdown"  (click)="editStack('revision', i)">
                                                            <div class="d-flex gap-2">
                                                              <span nz-icon nzType="diff" nzTheme="twotone"></span>
                                                              <p class="m-0 p-0">Revision</p>
                                                            </div>
                                                          </li>
                                                        </ng-container>
                                                        <li nz-menu-item class="gap-2 list-dropdown" (click)="removeStacks(i)">
                                                            <div class="d-flex gap-2">
                                                                <span nz-icon nzType="delete" nzTheme="twotone" [nzTwotoneColor]="'#f50'"></span>
                                                                <p class="m-0 p-0" style="color: #f50;">Delete</p>  
                                                            </div>
                                                        </li>
                                                    </ul>
                                                </nz-dropdown-menu>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <ng-container *ngIf="modal_type === 'edit';else hideQuotationTotal">
                                            <td colspan="5" class="text-center">
                                                <button (click)="addStacks()" nz-button nzType="primary" class="w-75">Add Stack</button>
                                            </td>
                                            <td colspan="5" class="text-center">
                                                <button (click)="createQuotationTotal()" nz-button nzType="default" class="w-75">
                                                    {{ dataQuotation.project.project_category === 'cat_awared' ? 'Create Contract Revision' : 'Create Quotation Total' }}
                                                </button>
                                            </td>
                                        </ng-container>
                                        <ng-template #hideQuotationTotal>
                                            <td colspan="10" class="text-center">
                                                <button (click)="addStacks()" nz-button nzType="primary" class="w-75">Add Stack</button>
                                            </td>
                                        </ng-template>
                                    </tr>
                                </ng-container>
                            </tbody>
                        </table>
                    </div>
                </nz-tab>
                <nz-tab *ngIf="this.isCreateQuotationTotal" nzTitle="Quotation">

                    <div class="row">
                        <div class="col-md-3">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="delivery_duration" class="fw-semibold">Delivery Duration</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="delivery_duration"/>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-3">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="offer_applies" class="fw-semibold">Offer Applies</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="offer_applies"/>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-3">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="type_of_work" class="fw-semibold">Type of Work</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="type_of_work"/>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                        <div class="col-md-3">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="termin_payment" class="fw-semibold">Termin Payment</nz-form-label>
                                <nz-form-control>
                                    <input nz-input formControlName="termin_payment"/>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>

                    <div class="row">
                        <!-- <p class="m-0 p-0 fw-bold col-12">Stacks</p>
                        <div class="col-12">
                            <p class="m-0 p-0 text-uppercase">
                                <ng-container *ngFor='let s of selectedStack; let isLast = last'>
                                    {{ s }} {{ isLast ? '' : ', ' }}
                                </ng-container>
                            </p>
                        </div> -->
                        <div class="col-4">
                            <nz-form-item>
                                <nz-form-label nzRequired nzFor="tax" class="fw-semibold">Tax</nz-form-label>
                                <nz-form-control>
                                    <nz-input-number-group class="w-100" nzAddOnAfter="%">
                                        <nz-input-number [nzMin]="0" formControlName="tax"></nz-input-number>
                                    </nz-input-number-group>
                                </nz-form-control>
                            </nz-form-item>
                        </div>
                    </div>

                    <nz-tabset [nzAnimated]="false">
                        <nz-tab nzTitle="Material">
                            <div class="table-responsive">
                                <table class="table table-order table-purchase">
                                    <thead>
                                        <tr>
                                            <th scope="col">No.</th>
                                            <th scope="col">Part Number</th>
                                            <th scope="col">Product Description</th>
                                            <th scope="col">Alias</th>
                                            <th scope="col">DN</th>
                                            <th scope="col">DN</th>
                                            <th scope="col">Unit</th>
                                            <th scope="col">Qty</th>
                                            <th scope="col">Price List</th>
                                            <th scope="col">Total Cost</th>
                                            <th scope="col">Discount</th>
                                            <th scope="col">Unit Price</th>
                                            <th scope="col">Total Selling Price</th>
                                            <th scope="col">Gross Margin</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <ng-container formArrayName="items">
                                            <ng-container *ngFor="let category of objectKeys(groupedItems);let catIndex = index">
                                                <tr>
                                                    <td class="fw-bold">
                                                        1.{{catIndex + 1}}
                                                    </td>
                                                    <td class="" colspan="13">
                                                        <span class="fw-bold">{{category}}</span>
                                                    </td>
                                                </tr>

                                                <tr *ngIf="groupedItems[category].items.length > 0">
                                                    <td class="" colspan="14">
                                                        <div class="d-flex flex-column gap-2">
                                                            <span class="fw-bold">Discount</span>
                                                            <nz-input-number-group class="w-25" nzAddOnAfter="%">
                                                                <nz-input-number [nzMin]="0" [formControl]="groupedItems[category].discount"></nz-input-number>
                                                            </nz-input-number-group>
                                                        </div>
                                                    </td>
                                                </tr>
        
                                                <ng-container>
                                                    <tr *ngFor="let item of groupedItems[category].items; let i = index" [formGroup]="item">
                                                        <td>{{ calculateGlobalIndex(catIndex, i) }}</td>
                                                        <td>                                                            
                                                            {{ item.get('exist')?.value 
                                                                ? getCodeById(item.get('part_number')?.value)
                                                                : item.get('part_number')?.value
                                                            }}
                                                            <br />
                                                            <nz-alert
                                                                *ngIf="!item.get('exist')?.value"
                                                                nzType="error"
                                                                nzMessage="Item not registered yet in inventory"
                                                            ></nz-alert>
                                                        </td>
                                                        <td>
                                                            {{ item.get('exist')?.value 
                                                                ? getDescById(item.get('part_number')?.value)
                                                                : item.get('part_number')?.value
                                                            }}
                                                            <br />
                                                            <nz-alert
                                                                *ngIf="!item.get('exist')?.value"
                                                                nzType="error"
                                                                nzMessage="Item not registered yet in inventory"
                                                            ></nz-alert>
                                                        </td>
                                                        <td>
                                                            {{ item.get('alias')?.value }}
                                                        </td>
                                                        <td>
                                                            {{ item.get('dn1')?.value }}
                                                        </td>
                                                        <td>
                                                            {{ item.get('dn2')?.value }}
                                                        </td>
                                                        <td>
                                                            {{ item.get('unit')?.value }}
                                                        </td>
                                                        <td>
                                                            {{ item.get('qty')?.value }}
                                                        </td>
                                                        <td>
                                                            {{ item.get('price_list')?.value | number:'1.0-0' }}
                                                        </td>
                                                        <td>
                                                            Rp {{ (item.get('qty')?.value * item.get('price_list')?.value) | number:'1.0-0' }}
                                                        </td>
                                                        <td> {{ groupedItems[category].discount.value}} % </td>
                                                        <td>
                                                            Rp {{ item.get('unit_price')?.value | number:'1.0-0' }}
                                                        </td>
                                                        <td>
                                                            Rp. {{ item.get('total_price')?.value | number:'1.0-0' }}
                                                        </td>
                                                        <td>
                                                            {{ item.get('gross_margin')?.value }} %
                                                        </td>
                                                    </tr>
                                                </ng-container>
                                            </ng-container>
                                        </ng-container>


                                        <tr>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td>
                                                <span class="fw-bold">Total Grand Cost:</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold"> Rp.  {{ totalGrandPriceList | number:'1.0-0' }}</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold">Total Grand Selling Price:</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold"> Rp.  {{ totalGrandCost | number:'1.0-0' }}</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold">Total Grand Gross Margin:</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold"> {{ totalGrandGrossMargin }} %</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </nz-tab>
                        <nz-tab nzTitle="Installation">
                            <nz-collapse>
                                <nz-collapse-panel nzHeader="2.1 Preliminaries">
                                    <div class="row">
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="preliminaries_cost" class="fw-semibold">Cost</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number-group nzAddOnBefore="Rp. " class="w-100">
                                                        <nz-input-number
                                                        id="preliminaries_cost"
                                                        formControlName="preliminaries_cost"
                                                        [nzFormatter]="formatter"
                                                        [nzMin]="0"
                                                        ></nz-input-number>
                                                    </nz-input-number-group>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="preliminaries_price_factor" class="fw-semibold">Price Factor</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number
                                                    class="w-100"
                                                    id="preliminaries_price_factor"
                                                    formControlName="preliminaries_price_factor"
                                                    [nzMin]="0"
                                                    ></nz-input-number>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="discount_preliminaries" class="w-100 fw-semibold">Discount</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number-group nzAddOnAfter="%" class="w-100">
                                                        <nz-input-number
                                                        id="discount_preliminaries"
                                                        formControlName="discount_preliminaries"
                                                        [nzMin]="0"
                                                        ></nz-input-number>
                                                    </nz-input-number-group>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="preliminaries_selling" class="w-100 fw-semibold">Selling Price</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number-group nzAddOnBefore="Rp. " class="w-100">
                                                        <nz-input-number
                                                        id="preliminaries_selling"
                                                        formControlName="preliminaries_selling"
                                                        [nzFormatter]="formatter"
                                                        [nzMin]="0"
                                                        ></nz-input-number>
                                                    </nz-input-number-group>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="preliminaries_gross_margin" class="w-100 fw-semibold">Gross Margin</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number-group nzAddOnAfter="%" class="w-100">
                                                        <nz-input-number
                                                        id="preliminaries_gross_margin"
                                                        formControlName="preliminaries_gross_margin"
                                                        [nzMin]="0"
                                                        ></nz-input-number>
                                                    </nz-input-number-group>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                    </div>
                                </nz-collapse-panel>
                                <nz-collapse-panel nzHeader="2.2 Material Installation">
                                    <ng-container formArrayName="items">
                                        <ng-container *ngFor="let category of objectKeys(groupedItems); let catIndex = index">
                                            <div class="table-responsive">
                                                <table class="table table-installation" [ngClass]="{'mt-2': groupedItems[category].items.length === 0}">
                                                    <thead>
        
                                                        <tr class="table-active sticky-head" style="width: 100%">
                                                            <th scope="col" colSpan="16" style="width: 100%;">{{ category }}</th>
                                                        </tr>
        
                                                        <tr class="sticky-head" *ngIf="groupedItems[category].items.length > 0">
                                                            <th class="" colspan="16">
                                                                <div class="d-flex flex-column gap-2">
                                                                    <span class="fw-bold">Discount</span>
                                                                    <nz-input-number-group class="w-25" nzAddOnAfter="%">
                                                                        <nz-input-number [nzMin]="0" [formControl]="groupedItems[category].discount_installation"></nz-input-number>
                                                                    </nz-input-number-group>
                                                                </div>
                                                            </th>
                                                        </tr>
        
                                                        <tr *ngIf="groupedItems[category].items.length > 0" class="sticky-head table-active ">
                                                            <th scope="col">No.</th>
                                                            <th scope="col">Part Number</th>
                                                            <th scope="col">Product Description</th>
                                                            <th scope="col">Alias</th>
                                                            <th scope="col">Unit</th>
                                                            <th scope="col">Qty</th>
                                                            <th scope="col">Price List</th>
                                                            <th scope="col">Inch</th>
                                                            <th scope="col">
                                                                {{ category.toLowerCase() === 'pipe' ? 'Cost/M\'' : 'Cost/Unit'  }}
                                                            </th>
                                                            <th scope="col">
                                                                {{ category.toLowerCase() === 'pipe' ? 'Cost M\'/inch' : 'Cost Unit/Inch'  }}
                                                            </th>
                                                            <th scope="col">Total Cost</th>
                                                            <th scope="col">Discount</th>
                                                            <th scope="col">Price Factor</th>
                                                            <th scope="col">Selling Price</th>
                                                            <th scope="col">Total Selling Price</th>
                                                            <th scope="col">Gross Margin</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody *ngIf="groupedItems[category].items.length > 0">
                                                        <ng-container>
                                                            <tr  *ngFor="let item of groupedItems[category].items; let i = index" [formGroup]="item">
                                                                <td>{{ calculateGlobalIndex(catIndex, i) }}</td>
                                                                <td>
                                                                    {{ item.get('i_part_number')?.value }}
                                                                </td>
                                                                <td>
                                                                    {{ item.get('i_description')?.value }}
                                                                </td>
                                                                <td>
                                                                    {{ item.get('alias')?.value }}
                                                                </td>
                                                                <td>
                                                                    {{ item.get('unit')?.value }}
                                                                </td>
                                                                <td>
                                                                    {{ item.get('qty')?.value }}
                                                                </td>
                                                                <td>
                                                                    Rp. {{ item.get('price_list')?.value | number:'1.0-0'  }}
                                                                </td>
                                                                <td>
                                                                    <ng-container *ngIf="item.get('installation_unit_price_type')?.value === 'price'; else emptyUnitPrice">
                                                                        <nz-input-number-group class="w-100">
                                                                            <nz-input-number class="w-100" [nzMin]="0" formControlName="installation_unit_inch_qty"></nz-input-number>
                                                                        </nz-input-number-group>
                                                                    </ng-container>
                                                                    <ng-template #emptyUnitPrice>
                                                                        -
                                                                    </ng-template>
                                                                </td>
                                                                <td>
                                                                    <div class="d-flex flex-column">
                                                                        <ng-container *ngIf="item.get('installation_unit_price_type')?.value === 'percent';else price">
                                                                            <nz-input-number-group nzAddOnAfter="%">
                                                                                <nz-input-number formControlName="installation_unit_price"></nz-input-number>
                                                                            </nz-input-number-group>
                                                                        </ng-container>
                                                                        <ng-template #price>
                                                                            <nz-input-number-group nzAddOnBefore="Rp. ">
                                                                                <nz-input-number     
                                                                                formControlName="installation_unit_price"
                                                                                [nzFormatter]="formatter"
                                                                                ></nz-input-number>
                                                                            </nz-input-number-group>
                                                                        </ng-template>
                                                                        <nz-radio-group formControlName="installation_unit_price_type" class="mt-2">
                                                                            <label nz-radio nzValue="percent">Percent</label>
                                                                            <label nz-radio nzValue="price">Price</label>
                                                                        </nz-radio-group>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    Rp. {{ item.get('installation_price_per_unit')?.value | number:'1.0-0' }}
                                                                </td>
                                                                <td>
                                                                    Rp. {{ item.get('installation_price_per_unit')?.value * item.get('qty')?.value  | number:'1.0-0' }}
                                                                </td>
                                                                <td> {{ groupedItems[category].discount.value}} % </td>
                                                                <td>
                                                                    <nz-input-number-group class="w-100">
                                                                        <nz-input-number class="w-100" [nzMin]="0" formControlName="installation_price_factor"></nz-input-number>
                                                                    </nz-input-number-group>
                                                                </td>
                                                                <td>
                                                                    Rp. {{ item.get('installation_selling_price')?.value | number:'1.0-0' }}
                                                                </td>
                                                                <td>
                                                                    Rp. {{ item.get('installation_selling_price')?.value * item.get('qty')?.value  | number:'1.0-0' }}
                                                                </td>
                                                                <td>
                                                                    {{ item.get('installation_gross_margin')?.value }} %
                                                                </td>
                                                            </tr>
                                                        </ng-container>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </ng-container>
                                        <div class="mt-4">
                                            <table class="table table-order">
                                                <tbody>
                                                    <tr>
                                                        <td>
                                                            <span class="fw-bold">Total Grand Cost:</span>
                                                        </td>
                                                        <td>
                                                            <span class="fw-bold"> Rp.  {{ totalGrandICost | number:'1.0-0' }}</span>
                                                        </td>
                                                        <td>
                                                            <span class="fw-bold">Total Grand Selling Price:</span>
                                                        </td>
                                                        <td>
                                                            <span class="fw-bold"> Rp.  {{ iTotalGrandCost | number:'1.0-0' }}</span>
                                                        </td>
                                                        <td>
                                                            <span class="fw-bold">Total Grand Gross Margin:</span>
                                                        </td>
                                                        <td>
                                                            <span class="fw-bold"> {{iTotalGrandGrossMargin }} %</span>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
        
                                    </ng-container>
                                </nz-collapse-panel>
                                <nz-collapse-panel nzHeader="2.3 Supervision">
                                    <div class="row">
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="supervision_cost" class="fw-semibold">Cost</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number-group nzAddOnBefore="Rp. " class="w-100">
                                                        <nz-input-number
                                                        id="supervision_cost"
                                                        formControlName="supervision_cost"
                                                        [nzFormatter]="formatter"
                                                        [nzMin]="0"
                                                        ></nz-input-number>
                                                    </nz-input-number-group>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="discount_supervision" class="w-100 fw-semibold">Discount</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number-group nzAddOnAfter="%" class="w-100">
                                                        <nz-input-number
                                                        id="discount_supervision"
                                                        formControlName="discount_supervision"
                                                        [nzMin]="0"
                                                        ></nz-input-number>
                                                    </nz-input-number-group>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="supervision_price_factor" class="fw-semibold">Price Factor</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number
                                                    class="w-100"
                                                    id="supervision_price_factor"
                                                    formControlName="supervision_price_factor"
                                                    [nzMin]="0"
                                                    ></nz-input-number>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="supervision_selling" class="w-100 fw-semibold">Selling Price</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number-group nzAddOnBefore="Rp. " class="w-100">
                                                        <nz-input-number
                                                        id="supervision_selling"
                                                        formControlName="supervision_selling"
                                                        [nzFormatter]="formatter"
                                                        [nzMin]="0"
                                                        ></nz-input-number>
                                                    </nz-input-number-group>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="supervision_gross_margin" class="w-100 fw-semibold">Gross Margin</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number-group nzAddOnAfter="%" class="w-100">
                                                        <nz-input-number
                                                        id="supervision_gross_margin"
                                                        formControlName="supervision_gross_margin"
                                                        [nzMin]="0"
                                                        ></nz-input-number>
                                                    </nz-input-number-group>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                    </div>
                                </nz-collapse-panel>
                                <nz-collapse-panel nzHeader="2.4 Test Commisioning">
                                    <div class="row">
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="test_commisioning_cost" class="fw-semibold">Cost</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number-group nzAddOnBefore="Rp. " class="w-100">
                                                        <nz-input-number
                                                        id="test_commisioning_cost"
                                                        formControlName="test_commisioning_cost"
                                                        [nzFormatter]="formatter"
                                                        [nzMin]="0"
                                                        ></nz-input-number>
                                                    </nz-input-number-group>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="discount_test_commisioning" class="w-100 fw-semibold">Discount</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number-group nzAddOnAfter="%" class="w-100">
                                                        <nz-input-number
                                                        id="discount_test_commisioning"
                                                        formControlName="discount_test_commisioning"
                                                        [nzMin]="0"
                                                        ></nz-input-number>
                                                    </nz-input-number-group>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="test_commisioning_price_factor" class="fw-semibold">Price Factor</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number
                                                    class="w-100"
                                                    id="test_commisioning_price_factor"
                                                    formControlName="test_commisioning_price_factor"
                                                    [nzMin]="0"
                                                    ></nz-input-number>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="test_commisioning_selling" class="w-100 fw-semibold">Selling Price</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number-group nzAddOnBefore="Rp. " class="w-100">
                                                        <nz-input-number
                                                        id="test_commisioning_selling"
                                                        formControlName="test_commisioning_selling"
                                                        [nzFormatter]="formatter"
                                                        [nzMin]="0"
                                                        ></nz-input-number>
                                                    </nz-input-number-group>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                        <div class="col-4">
                                            <nz-form-item>
                                                <nz-form-label nzRequired nzFor="test_commisioning_gross_margin" class="w-100 fw-semibold">Gross Margin</nz-form-label>
                                                <nz-form-control>
                                                    <nz-input-number-group nzAddOnAfter="%" class="w-100">
                                                        <nz-input-number
                                                        id="test_commisioning_gross_margin"
                                                        formControlName="test_commisioning_gross_margin"
                                                        [nzMin]="0"
                                                        ></nz-input-number>
                                                    </nz-input-number-group>
                                                </nz-form-control>
                                            </nz-form-item>
                                        </div>
                                    </div>
                                </nz-collapse-panel>
                            </nz-collapse>

                            <div class="row mt-4">
                                <div class="col-md-8">

                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex justify-content-between pb-2" style="border-bottom: 2px solid black">
                                        <div class="d-flex flex-column gap-2">
                                            <span class="fw-semibold">Total Selling Pleminaries</span>
                                            <span class="fw-semibold">Total Selling Material Installation</span>
                                            <span class="fw-semibold">Total Selling Supervision</span>
                                            <span class="fw-semibold">Total Selling Test Commisioning</span>
                                        </div>

                                        <div class="d-flex flex-column gap-2">
                                            <span class="fw-semibold">Rp. {{ quotationForm.get('preliminaries_selling')?.value | number: '1.0-0' }}</span>
                                            <span class="fw-semibold">Rp.  {{ iTotalGrandCost | number:'1.0-0' }}</span>
                                            <span class="fw-semibold">Rp. {{ quotationForm.get('supervision_selling')?.value | number: '1.0-0' }}</span>
                                            <span class="fw-semibold">Rp. {{ quotationForm.get('test_commisioning_selling')?.value | number: '1.0-0' }}</span>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-between mt-3">
                                        <div class="d-flex flex-column gap-2">
                                            <span class="fw-semibold">Total Installation</span>
                                        </div>

                                        <div class="d-flex flex-column gap-2">
                                            <span class="fw-semibold">Rp. {{ quotationForm.get('preliminaries_selling')?.value + iTotalGrandCost +  quotationForm.get('supervision_selling')?.value + quotationForm.get('test_commisioning_selling')?.value  | number: '1.0-0' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </nz-tab>
                        <nz-tab nzTitle="Total">
                            <div class="table-responsive" style="border-bottom: 1px solid lightgray;">
                                <table class="table table-order table-purchase">
                                    <thead>
                                        <tr>
                                            <th scope="col">No.</th>
                                            <th scope="col">Part Number</th>
                                            <th scope="col">Product Description</th>
                                            <th scope="col">Alias</th>
                                            <th scope="col">Qty</th>
                                            <th scope="col">Unit</th>
                                            <th scope="col">Price List</th>
                                            <th scope="col">Total Price List</th>
                                            <th scope="col">Discount</th>
                                            <th scope="col">Unit Price</th>
                                            <th scope="col">Total Selling Price</th>
                                            <th scope="col">Gross Margin</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="table-secondary">
                                            <td class="fw-bold top-header">1</td>
                                            <td colspan="11" class="top-header">
                                                <span class="fw-bold" style="font-size: 16px;">
                                                    Material
                                                </span>
                                            </td>
                                        </tr>
                                        <ng-container formArrayName="items">
                                            <ng-container *ngFor="let category of objectKeys(groupedItems); let catIndex = index">
                                                <tr>
                                                    <td class="fw-bold">1. {{catIndex + 1}}</td>
                                                    <td class="" [colSpan]="groupedItems[category].items.length > 0 ? '6' : '11'">
                                                        <span class="fw-bold">{{category}}</span>
                                                    </td>
                                                    <ng-container *ngIf="groupedItems[category].items.length > 0">
                                                        <td colspan="3">
                                                            <span class="fw-bold">
                                                                Rp. {{ groupedItems[category].totalPriceList.value | number:'1.0-0' }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="fw-bold">
                                                                Rp. {{ groupedItems[category].totalPrice.value | number:'1.0-0' }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="fw-bold">
                                                               {{ groupedItems[category].grossMargin }} %
                                                            </span>
                                                        </td>
                                                    </ng-container>

                                                </tr>
                                                

                                                <tr *ngFor="let item of groupedItems[category].items; let i = index" [formGroup]="item">
                                                    <td>{{ calculateGlobalIndex(catIndex, i) }}</td>
                                                    <td>                                                            
                                                        {{ item.get('exist')?.value 
                                                            ? getCodeById(item.get('part_number')?.value)
                                                            : item.get('part_number')?.value
                                                        }}
                                                        <br />
                                                        <nz-alert
                                                            *ngIf="!item.get('exist')?.value"
                                                            nzType="error"
                                                            nzMessage="Item not registered yet in inventory"
                                                        ></nz-alert>
                                                    </td>
                                                    <td>
                                                        {{ item.get('exist')?.value 
                                                            ? getDescById(item.get('part_number')?.value)
                                                            : item.get('part_number')?.value
                                                        }}
                                                        <br />
                                                        <nz-alert
                                                            *ngIf="!item.get('exist')?.value"
                                                            nzType="error"
                                                            nzMessage="Item not registered yet in inventory"
                                                        ></nz-alert>
                                                    </td>
                                                    <td>
                                                        {{ item.get('alias')?.value }}
                                                    </td>
                                                    <td>
                                                        {{ item.get('qty')?.value }}
                                                    </td>
                                                    <td>
                                                        {{ item.get('unit')?.value }}
                                                    </td>
                                                    <td>
                                                        Rp {{ item.get('price_list')?.value | number:'1.0-0' }}
                                                    </td>
                                                    <td>
                                                        Rp {{ ( item.get('qty')?.value * item.get('price_list')?.value ) | number:'1.0-0' }}
                                                    </td>
                                                    <td>
                                                        {{ groupedItems[category].discount.value}} %
                                                    </td>
                                                    <td>
                                                        Rp {{ item.get('unit_price')?.value | number:'1.0-0' }}
                                                    </td>
                                                    <td>
                                                        Rp. {{ item.get('total_price')?.value | number:'1.0-0' }}
                                                    </td>
                                                    <td>
                                                        {{ item.get('gross_margin')?.value }} %
                                                    </td>
                                                </tr>
                                            </ng-container>
                                        </ng-container>

                                        <tr class="table-secondary">
                                            <td class="fw-bold top-header">2</td>
                                            <td colSpan="11" class="top-header">
                                                <span class="fw-bold" style="font-size: 16px;">
                                                    Material Installation
                                                </span>
                                            </td>
                                        </tr>

                                        <ng-container formArrayName="items">
                                            <ng-container *ngFor="let category of objectKeys(groupedItems); let catIndex = index">
                                                <tr>
                                                    <td class="fw-bold">2.{{catIndex + 1}}</td>
                                                    <td class="" [colSpan]="groupedItems[category].items.length > 0 ? '6' : '12'">
                                                        <span class="fw-bold">{{category}}</span>
                                                    </td>
                                                    <ng-container *ngIf="groupedItems[category].items.length > 0">
                                                        <td colspan="3">
                                                            <span class="fw-bold">
                                                                Rp. {{ groupedItems[category].iTotalCost.value | number:'1.0-0' }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="fw-bold">
                                                                Rp. {{ groupedItems[category].iTotalPrice.value | number:'1.0-0' }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="fw-bold">
                                                               {{ groupedItems[category].iGrossMargin }} %
                                                            </span>
                                                        </td>
                                                    </ng-container>
                                                </tr>
                                                <tr *ngFor="let item of groupedItems[category].items; let i = index" [formGroup]="item">
                                                     <td>{{ calculateGlobalIndex(catIndex, i) }}</td>
                                                    <td>
                                                        {{ item.get('i_part_number')?.value }}
                                                    </td>
                                                    <td>
                                                        {{ item.get('i_description')?.value }}
                                                    </td>
                                                    <td>
                                                        {{ item.get('alias')?.value }}
                                                    </td>
                                                    <td> {{ item.get('qty')?.value }}</td>
                                                    <td>
                                                        {{ category.toLowerCase() === 'pipe' ? 'M\'' : 'Pcs'  }}
                                                    </td>
                                                    <td>
                                                        Rp {{ item.get('installation_price_per_unit')?.value | number:'1.0-0' }}
                                                    </td>
                                                    <td>
                                                        Rp {{ ( item.get('qty')?.value * item.get('installation_price_per_unit')?.value ) | number:'1.0-0' }}
                                                    </td>
                                                    <td>
                                                        {{ groupedItems[category].discount_installation.value}} %
                                                    </td>
                                                    <td>
                                                        Rp. {{ item.get('installation_selling_price')?.value | number:'1.0-0' }}
                                                    </td>
                                                    <td>
                                                        Rp. {{ item.get('qty')?.value * item.get('installation_selling_price')?.value | number:'1.0-0' }}
                                                    </td>
                                                    <td>
                                                        {{ item.get('installation_gross_margin')?.value }} %
                                                    </td>
                                                </tr>
                                            </ng-container>
                                        </ng-container>
                                        <!-- <tr>
                                            <td class="" [colSpan]='7'>
                                                -
                                            </td>
                                            <td colspan="3">
                                                <span class="fw-bold">
                                                    Rp. {{ totalGrandPriceList + totalGrandICost | number:'1.0-0' }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="fw-bold">
                                                    Rp. {{ totalGrandCost + iTotalGrandCost | number:'1.0-0' }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="fw-bold">
                                                   {{ (( ( (totalGrandCost + iTotalGrandCost ) - (totalGrandPriceList + totalGrandICost) ) / (totalGrandCost + iTotalGrandCost )) * 100).toFixed(2) }} %
                                                </span>
                                            </td>
                                        </tr> -->
                                        <!-- <tr>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td>
                                                <span class="fw-bold">Total Grand Selling Price:</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold"> Rp.  {{ totalGrandCost | number:'1.0-0' }}</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold">Total Grand Gross Margin:</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold"> {{ totalGrandGrossMargin }} %</span>
                                            </td>
                                        </tr> -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="row mt-4">
                                <div class="col-md-8">

                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex justify-content-between pb-2" style="border-bottom: 2px solid black">
                                        <div class="d-flex flex-column gap-2">
                                            <span class="fw-semibold">Gross Margin</span>
                                            <span class="fw-semibold">Sub Total 1</span>
                                            <span class="fw-semibold">Sub Total 2</span>
                                        </div>

                                        <div class="d-flex flex-column gap-2">
                                            <span class="fw-semibold">
                                                {{
                                                    (((
                                                        (
                                                            totalGrandCost 
                                                            + (+quotationForm.get('preliminaries_selling')?.value || 0)
                                                            + iTotalGrandCost 
                                                            + (+quotationForm.get('supervision_selling')?.value || 0)
                                                            + (+quotationForm.get('test_commisioning_selling')?.value || 0)
                                                        )
                                                        -
                                                        (
                                                            totalGrandPriceList 
                                                            + (+quotationForm.get('preliminaries_cost')?.value || 0)
                                                            + totalGrandICost 
                                                            + (+quotationForm.get('supervision_cost')?.value || 0)
                                                            + (+quotationForm.get('test_commisioning_cost')?.value || 0)  
                                                        )
                                                    )
                                                    /
                                                    (
                                                        totalGrandCost 
                                                        + (+quotationForm.get('preliminaries_selling')?.value || 0)
                                                        + iTotalGrandCost 
                                                        + (+quotationForm.get('supervision_selling')?.value || 0)
                                                        + (+quotationForm.get('test_commisioning_selling')?.value || 0)
                                                    )) * 100).toFixed(2)}} %
                                            </span>
                                            <span class="fw-semibold">Rp. {{ totalGrandCost | number: '1.0-0' }}</span>
                                            <span class="fw-semibold">
                                                Rp. {{ (
                                                    + quotationForm.get('preliminaries_selling')?.value 
                                                    + iTotalGrandCost 
                                                    +  quotationForm.get('supervision_selling')?.value 
                                                    + quotationForm.get('test_commisioning_selling')?.value 
                                                ) | number: '1.0-0' }}
                                            </span>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-between mt-3">
                                        <div class="d-flex flex-column gap-2">
                                            <span class="fw-semibold">Total (1+2)</span>
                                            <span class="fw-semibold">Round</span>
                                            <span class="fw-semibold">Tax({{quotationForm.get('tax')?.value}}%)</span>
                                            <span class="fw-semibold">Grand Total</span>
                                        </div>

                                        <div class="d-flex flex-column gap-2">
                                            <span class="fw-semibold">
                                                Rp. {{ (totalGrandCost 
                                                    + quotationForm.get('preliminaries_selling')?.value 
                                                    + iTotalGrandCost 
                                                    +  quotationForm.get('supervision_selling')?.value 
                                                    + quotationForm.get('test_commisioning_selling')?.value 
                                                ) | number: '1.0-0' }}
                                            </span>
                                            <span class="fw-semibold">
                                                Rp. {{ (totalGrandCost 
                                                    + quotationForm.get('preliminaries_selling')?.value 
                                                    + iTotalGrandCost 
                                                    +  quotationForm.get('supervision_selling')?.value 
                                                    + quotationForm.get('test_commisioning_selling')?.value 
                                                ) | number: '1.0-0' }}
                                            </span>
                                            <span class="fw-semibold">
                                                Rp. {{ ((totalGrandCost 
                                                    + (+quotationForm.get('preliminaries_selling')?.value || 0)
                                                    + iTotalGrandCost 
                                                    + (+quotationForm.get('supervision_selling')?.value || 0)
                                                    + (+quotationForm.get('test_commisioning_selling')?.value || 0)
                                                ) * ((+quotationForm.get('tax')?.value || 0) / 100) ) | number: '1.0-0' }}
                                            </span>
                                            <span class="fw-semibold">
                                                Rp. {{ ((totalGrandCost 
                                                    + (+quotationForm.get('preliminaries_selling')?.value || 0)
                                                    + iTotalGrandCost 
                                                    + (+quotationForm.get('supervision_selling')?.value || 0)
                                                    + (+quotationForm.get('test_commisioning_selling')?.value || 0)
                                                )
                                                    + (totalGrandCost 
                                                    + (+quotationForm.get('preliminaries_selling')?.value || 0)
                                                    + iTotalGrandCost 
                                                    + (+quotationForm.get('supervision_selling')?.value || 0)
                                                    + (+quotationForm.get('test_commisioning_selling')?.value || 0)
                                                ) * ((+quotationForm.get('tax')?.value || 0) / 100) ) | number: '1.0-0' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </nz-tab>
                    </nz-tabset>

                </nz-tab>


            </nz-tabset>
        </form>
    </div>
    <div class="footer">
        <div class="d-flex gap-2 justify-content-end">
            <button nz-button nzType="default" (click)="closeDrawer()">Cancel</button>
            <button nz-button nzType="primary" (click)="submit()">
                <ng-container *ngIf="modal_type === 'add'">Add Quotation</ng-container>
                <ng-container *ngIf="modal_type === 'edit'">Edit Quotation</ng-container>
                <ng-container *ngIf="modal_type === 'revision'">Revised Quotation</ng-container>
            </button>
        </div>
    </div>
</div>