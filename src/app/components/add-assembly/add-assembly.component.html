<div>
    <div class="form-body">
        <form nz-form nzLayout="vertical" [formGroup]="assemblyForm">
            <div class="row">
                <div class="col-md-4">
                    <nz-form-item class="mb-4">
                        <nz-form-label nzRequired nzFor="pic" class="fw-semibold">PIC SFM</nz-form-label>
                        <ng-container *ngIf="pic$ | async as pic; else picLoad">
                            <nz-select nzShowSearch nzMode="tags" nzPlaceHolder="Select PIC" formControlName="pic">
                                <nz-option
                                *ngFor="let p of pic"
                                    [nzLabel]="p.name" 
                                    [nzValue]="p.pic_id"
                                ></nz-option>
                            </nz-select>
                        </ng-container>
                        <ng-template #picLoad>
                            <nz-select nzShowSearch nzMode="tags" nzPlaceHolder="Select PIC" nzDisabled>
                                <nz-option></nz-option>
                            </nz-select>
                        </ng-template>
                    </nz-form-item>
                </div>

                <div class="col-md-4">
                    <nz-form-item>
                        <nz-form-label nzRequired class="fw-semibold" nzFor="is_pic_internal" nzRequired>Head of PIC SFM</nz-form-label>
                        <nz-form-control>
                            <nz-select nzShowSearch nzPlaceHolder="Select Head" formControlName="is_pic_internal">
                            <ng-container *ngFor="let pic of filteredListOfPic">
                            <nz-option [nzLabel]="pic.name" [nzValue]="pic.pic_id"></nz-option>
                            </ng-container>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>

                <div class="col-md-4">
                    <nz-form-item class="mb-4">
                        <nz-form-label nzRequired nzFor="description" class="fw-semibold">Description</nz-form-label>
                        <nz-form-control>
                            <input nz-input formControlName="description" id="description" />
                        </nz-form-control>
                    </nz-form-item>
                </div>

                <div class="col-md-4">
                    <nz-form-item class="mb-4">
                        <nz-form-label nzRequired nzFor="no_ref" class="fw-semibold"> Part Number </nz-form-label>
                        <nz-form-control>
                            <input nz-input formControlName="no_ref" id="no_ref" />
                        </nz-form-control>
                    </nz-form-item>
                </div>

                <div class="col-md-4">
                    <nz-form-item>
                    <nz-form-label nzRequired nzFor="date" class="fw-semibold">Date</nz-form-label>
                    <nz-form-control>
                        <nz-date-picker class="w-100" formControlName="date" id="date" nzPlaceHolder="pick a date"></nz-date-picker>
                    </nz-form-control>
                    </nz-form-item>
                </div>

                <div class="col-md-4">
                    <nz-form-item>
                        <nz-form-label nzRequired nzFor="qty" class="fw-semibold">Qty Assembly</nz-form-label>
                        <nz-form-control>
                            <nz-input-number 
                            class="w-100"    
                            formControlName="qty"
                            [nzMin]="1"
                            ></nz-input-number>
                        </nz-form-control>
                        </nz-form-item>
                </div>

                <nz-form-item>
                    <nz-form-label nzFor="status" nzRequired class="fw-semibold">Status</nz-form-label>
                    <nz-form-control>
                      <nz-switch nzSize="default" id="status" formControlName="status" nzCheckedChildren="active" nzUnCheckedChildren="inactive"></nz-switch>
                    </nz-form-control>
                </nz-form-item>

                <nz-tabset>
                    <nz-tab nzTitle="Raw Materials">
                        <div class="table-responsive">
                            <table class="table table-striped table-order table-raw">
                                <thead style="position: unset;">
                                    <tr>
                                        <th scope="col">Type</th>
                                        <th scope="col">Part Number</th>
                                        <th scope="col">Product Description</th>
                                        <th scope="col">Supplier</th>
                                        <th scope="col">Qty</th>
                                        <th scope="col">Qty Total</th>
                                        <th scope="col">Unit</th>
                                        <th scope="col">Price List</th>
                                        <th scope="col">Discount 1</th>
                                        <th scope="col">Product Cost 1</th>
                                        <th scope="col">Discount 2</th>
                                        <th scope="col">Product Cost 2</th>
                                        <th scope="col">Total Per Item</th>
                                        <th scope="col">Total</th>
                                        <th scope="col">#</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <ng-container formArrayName="order">
                                        <tr *ngFor="let order of order.controls; let i = index" [formGroupName]="i">
                                            <td>
                                                <nz-form-control>
                                                    <nz-select formControlName="type">
                                                        <nz-option
                                                            [nzLabel]="'Inventory'" 
                                                            [nzValue]="'inventory'"
                                                        ></nz-option>
                                                        <nz-option
                                                        [nzLabel]="'Assembly'" 
                                                        [nzValue]="'assembly'"
                                                    ></nz-option>
                                                    </nz-select>
                                                </nz-form-control>      
                                            </td>
                                            <td>
                                                <nz-form-control>
                                                    <nz-select nzShowSearch  nzPlaceHolder="Select Part Number" formControlName="product_code">
                                                        <ng-container *ngIf="order.get('type')?.value === 'inventory'">
                                                            <nz-option
                                                            *ngFor="let p of inventoryList.data"
                                                                [nzLabel]="p.code" 
                                                                [nzValue]="p.id"
                                                            ></nz-option>
                                                        </ng-container>
                                                        <ng-container *ngIf="order.get('type')?.value === 'assembly'">
                                                            <nz-option
                                                            *ngFor="let p of assemblyList.data"
                                                                [nzLabel]="p.no_ref" 
                                                                [nzValue]="p.id"
                                                            ></nz-option>
                                                        </ng-container>
                                                    </nz-select>
                                                </nz-form-control>                        
                                            </td>
                                            <td>
                                                <nz-form-control>
                                                    <nz-select nzShowSearch  nzPlaceHolder="Select Inventory" formControlName="inventory_id">
                                                        <ng-container *ngIf="order.get('type')?.value === 'inventory'">
                                                            <nz-option
                                                            *ngFor="let p of inventoryList.data"
                                                                [nzLabel]="p.description" 
                                                                [nzValue]="p.id"
                                                            ></nz-option>
                                                        </ng-container>
                                                        <ng-container *ngIf="order.get('type')?.value === 'assembly'">
                                                            <nz-option
                                                            *ngFor="let p of assemblyList.data"
                                                                [nzLabel]="p.description" 
                                                                [nzValue]="p.id"
                                                            ></nz-option>
                                                        </ng-container>
                                                    </nz-select>
                                                </nz-form-control>                        
                                            </td>
                                            <td>
                                                <ng-container *ngIf="order.get('type')?.value === 'inventory'">
                                                    <nz-form-control>
                                                        <nz-select nzShowSearch nzPlaceHolder="Select Supplier" formControlName="supplier">
                                                            <nz-option
                                                                *ngFor="let supplier of order.get('suppliersList')?.value"
                                                                [nzLabel]="supplier.supplier.name" 
                                                                [nzValue]="supplier.id"
                                                            ></nz-option>
                                                        </nz-select>
                                                    </nz-form-control>
                                                </ng-container>
                                                <ng-container *ngIf="order.get('type')?.value === 'assembly'">
                                                    <span>-</span>
                                                </ng-container>
                                            </td>
                                            <td>
                                                <nz-form-control>
                                                    <nz-input-number formControlName="qty" [nzMin]="0"></nz-input-number>
                                                </nz-form-control>  
                                            </td>
                                            <td>
                                                <p class="m-0 p-0">{{ order.get('qty_total')?.value }}</p>
                                            </td>
                                            <td>
                                                <ng-container *ngIf="order.get('type')?.value === 'inventory'">
                                                    <div>
                                                        <p class="m-0 p-0">{{ order.get('unit_measurement')?.value}} <sup>{{ order.get('unit_unit')?.value }}</sup> </p>
                                                    </div>
                                                </ng-container>
                                                <ng-container *ngIf="order.get('type')?.value === 'assembly'">
                                                    <span>-</span>
                                                </ng-container>
                                            </td>
                                            <td>
                                                <nz-form-control>
                                                    <nz-space nzDirection="vertical" style="width: 100%">
                                                        <nz-input-number-group *nzSpaceItem nzPrefix="Rp. " style="width: 100%">
                                                            <nz-input-number     
                                                            formControlName="price_list"
                                                            [nzFormatter]="formatter"
                                                            [nzMin]="0"
                                                            ></nz-input-number>
                                                        </nz-input-number-group>
                                                    </nz-space>
                                                </nz-form-control>  
                                            </td>
                                            <td>
                                                <ng-container *ngIf="order.get('type')?.value === 'inventory'">
                                                    <div class="d-flex flex-column">
                                                        <ng-container *ngIf="order.get('discount_type_1')?.value === 'percent';else price">
                                                            <nz-input-number-group nzAddOnAfter="%">
                                                                <nz-input-number formControlName="discount_1"></nz-input-number>
                                                            </nz-input-number-group>
                                                        </ng-container>
                                                        <ng-template #price>
                                                            <nz-input-number-group nzAddOnBefore="Rp. ">
                                                                <nz-input-number     
                                                                formControlName="discount_1"
                                                                [nzFormatter]="formatter"
                                                                ></nz-input-number>
                                                            </nz-input-number-group>
                                                        </ng-template>
                                                        <nz-radio-group formControlName="discount_type_1" class="mt-2">
                                                            <label nz-radio nzValue="percent">Percent</label>
                                                            <label nz-radio nzValue="price">Price</label>
                                                        </nz-radio-group>
                                                    </div>
                                                </ng-container>
                                                <ng-container *ngIf="order.get('type')?.value === 'assembly'">
                                                    <span>-</span>
                                                </ng-container>
                                            </td>
                                            <td>
                                                <ng-container *ngIf="order.get('type')?.value === 'inventory'">
                                                    <nz-form-control>
                                                        <nz-space nzDirection="vertical" style="width: 100%">
                                                            <nz-input-number-group *nzSpaceItem nzPrefix="Rp. " style="width: 100%">
                                                                <nz-input-number     
                                                                formControlName="product_cost_1"
                                                                [nzFormatter]="formatter"
                                                                [nzMin]="0"
                                                                ></nz-input-number>
                                                            </nz-input-number-group>
                                                        </nz-space>
                                                    </nz-form-control>  
                                                </ng-container>
                                                <ng-container *ngIf="order.get('type')?.value === 'assembly'">
                                                    <span>-</span>
                                                </ng-container>
                                            </td>
                                            <td>
                                                <ng-container *ngIf="order.get('type')?.value === 'inventory'">
                                                    <div class="d-flex flex-column">
                                                        <ng-container *ngIf="order.get('discount_type_2')?.value === 'percent';else price">
                                                            <nz-input-number-group nzAddOnAfter="%">
                                                                <nz-input-number formControlName="discount_2"></nz-input-number>
                                                            </nz-input-number-group>
                                                        </ng-container>
                                                        <ng-template #price>
                                                            <nz-input-number-group nzAddOnBefore="Rp. ">
                                                                <nz-input-number     
                                                                formControlName="discount_2"
                                                                [nzFormatter]="formatter"
                                                                ></nz-input-number>
                                                            </nz-input-number-group>
                                                        </ng-template>
                                                        <nz-radio-group formControlName="discount_type_2" class="mt-2">
                                                            <label nz-radio nzValue="percent">Percent</label>
                                                            <label nz-radio nzValue="price">Price</label>
                                                        </nz-radio-group>
                                                    </div>
                                                </ng-container>
                                                <ng-container *ngIf="order.get('type')?.value === 'assembly'">
                                                    <span>-</span>
                                                </ng-container>
                                            </td>
                                            <td>
                                                <ng-container *ngIf="order.get('type')?.value === 'inventory'">
                                                    <nz-form-control>
                                                        <nz-space nzDirection="vertical" style="width: 100%">
                                                            <nz-input-number-group *nzSpaceItem nzPrefix="Rp. " style="width: 100%">
                                                                <nz-input-number     
                                                                formControlName="product_cost_2"
                                                                [nzFormatter]="formatter"
                                                                [nzMin]="0"
                                                                ></nz-input-number>
                                                            </nz-input-number-group>
                                                        </nz-space>
                                                    </nz-form-control> 
                                                </ng-container>
                                                <ng-container *ngIf="order.get('type')?.value === 'assembly'">
                                                    <span>-</span>
                                                </ng-container>
                                            </td>
                                            <td>
                                                <div style="margin-top: 4px;">
                                                    <p class="m-0 p-0">Rp. {{ order.get('total_per_cost')?.value | number:'1.0-0' }}</p>
                                                </div>
                                            </td>                       
                                            <td>
                                                <div style="margin-top: 4px;">
                                                    <p class="m-0 p-0">Rp. {{ order.get('total_cost')?.value | number:'1.0-0' }}</p>
                                                </div>
                                            </td>
                                            <td>
                                                <span (click)="removeOrder(i)" nz-icon nzType="delete" nzTheme="twotone" [nzTwotoneColor]="'#ED0000'"></span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="14" class="text-center">
                                                <button (click)="addOrder()" nz-button nzType="primary" class="w-75" [disabled]="formDisable">Add Item</button>
                                            </td>
                                        </tr>
                                    </ng-container>
            
                                </tbody>
                            </table>
                        </div>

        
                        <div class="d-flex flex-column align-items-end gap-2 mt-5">
                            <div class="d-flex align-items-center justify-content-between" style="width: 30%;">
                                <p class="m-0 p-0 fw-semibold">Total Raw Materials(per Each)</p>
                                <p class="m-0 p-0 fw-semibold total-order">Rp {{ totalInventoryOrderPerItem | number:'1.0-0' }}</p>
                            </div>  
                            <div class="d-flex align-items-center justify-content-between" style="width: 30%;">
                                <p class="m-0 p-0 fw-semibold">Total Raw Materials</p>
                                <p class="m-0 p-0 fw-semibold total-order">Rp {{ totalInventoryOrder | number:'1.0-0' }}</p>
                            </div>
                        </div>
                    </nz-tab>
                    <nz-tab nzTitle="Additional Cost">
                        <div class="table-responsive">
                            <table class="table table-striped table-order">
                                <thead style="position: unset;">
                                    <tr>
                                        <th scope="col">Product Description</th>
                                        <th scope="col">Qty</th>
                                        <th scope="col">Unit</th>
                                        <th scope="col">Unit Code</th>
                                        <th scope="col">Price List</th>
                                        <th scope="col">Discount</th>
                                        <th scope="col">Total</th>
                                        <th scope="col">#</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <ng-container formArrayName="order_additional">
                                        <tr *ngFor="let order of orderAdditional.controls; let i = index" [formGroupName]="i">
                                            <td>
                                                <nz-form-control>
                                                    <input nz-input formControlName="product_description" />
                                                </nz-form-control>
                                            </td>
                                            <td>
                                                <nz-form-control>
                                                    <nz-input-number formControlName="qty" [nzMin]="0"></nz-input-number>
                                                </nz-form-control>  
                                            </td>
                                            <td>
                                                <ng-container *ngIf="unit$ | async as unit; else unitLoad">
                                                    <nz-select nzShowSearch nzPlaceHolder="Select Unit" formControlName="unit_id" [nzDropdownRender]="unitRender">
                                                        <nz-option
                                                            *ngFor="let u of unit.data"
                                                            [nzValue]="u.id"
                                                            [nzLabel]="u.name"
                                                        >
                                                        </nz-option>
                                                        <ng-template #unitRender>
                                                            <nz-divider class="m-0"></nz-divider>
                                                            <div class="container">
                                                              <a class="add-item" (click)="showModalUnit('uom')">
                                                                <span nz-icon nzType="plus"></span>
                                                                Add Unit
                                                              </a>
                                                            </div>
                                                        </ng-template>
                                                    </nz-select>
                                                </ng-container>
                                                <ng-template #unitLoad>
                                                    <nz-select nzShowSearch nzPlaceHolder="Select Unit" nzDisabled>
                                                        <nz-option></nz-option>
                                                    </nz-select>
                                                </ng-template>
                                            </td>
                                            <td>
                                                <div>
                                                    <p class="m-0 p-0">{{ order.get('measurement')?.value}} <sup>{{ order.get('unit')?.value }}</sup> </p>
                                                </div>
                                            </td>
                                            <td>
                                                <nz-form-control>
                                                    <nz-space nzDirection="vertical" style="width: 100%">
                                                        <nz-input-number-group *nzSpaceItem nzPrefix="Rp. " style="width: 100%">
                                                            <nz-input-number     
                                                            formControlName="price_list"
                                                            [nzFormatter]="formatter"
                                                            [nzMin]="0"
                                                            ></nz-input-number>
                                                        </nz-input-number-group>
                                                    </nz-space>
                                                </nz-form-control>  
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column">
                                                    <ng-container *ngIf="order.get('discount_type')?.value === 'percent';else priceAdditional">
                                                        <nz-input-number-group nzAddOnAfter="%">
                                                            <nz-input-number formControlName="discount"></nz-input-number>
                                                        </nz-input-number-group>
                                                    </ng-container>
                                                    <ng-template #priceAdditional>
                                                        <nz-input-number-group nzAddOnBefore="Rp. ">
                                                            <nz-input-number     
                                                            formControlName="discount_price"
                                                            [nzFormatter]="formatter"
                                                            ></nz-input-number>
                                                        </nz-input-number-group>
                                                    </ng-template>
                                                    <nz-radio-group formControlName="discount_type" class="mt-2">
                                                        <label nz-radio nzValue="percent">Percent</label>
                                                        <label nz-radio nzValue="price">Price</label>
                                                    </nz-radio-group>
                                                </div>
                                            </td>
                                            <td>
                                                <div style="margin-top: 4px;">
                                                    <p class="m-0 p-0">Rp. {{ order.get('total_cost')?.value | number:'1.0-0' }}</p>
                                                </div>
                                            </td>
                                            <td>
                                                <span (click)="removeOrderAdditional(i)" nz-icon nzType="delete" nzTheme="twotone" [nzTwotoneColor]="'#ED0000'"></span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="9" class="text-center">
                                                <button (click)="addOrderAdditional()" nz-button nzType="primary" class="w-75" [disabled]="formDisable">Add Additional</button>
                                            </td>
                                        </tr>
                                    </ng-container>
            
                                </tbody>
                            </table>
                        </div>

        
                        <div class="d-flex flex-column align-items-end gap-2">        
                            <div class="d-flex align-items-center justify-content-between" style="width: 30%;">
                                <p class="m-0 p-0 fw-semibold">Total Additional Cost</p>
                                <p class="m-0 p-0 fw-semibold total-order">Rp {{ totalAdditionalOrder | number:'1.0-0' }}</p>
                            </div>
                        </div>
                    </nz-tab>
                    <nz-tab nzTitle="Finish Goods">
                        <div class="table-responsive">
                            <table class="table table-striped table-order">
                                <thead style="position: unset;">
                                    <tr>
                                        <th scope="col">Product Description</th>
                                        <th scope="col">Part Number</th>
                                        <th scope="col">Qty</th>
                                        <th scope="col">Unit Code</th>
                                        <!-- <th scope="col">Price List</th>
                                        <th scope="col">Discount</th> -->
                                        <th scope="col">Total Cost</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <ng-container formArrayName="order">
                                        <tr *ngFor="let order of order.controls; let i = index" [formGroupName]="i">
                                            <td>
                                                {{ getInventoryDescription(order, order.get('type')?.value ) }}
                                            </td>
                                            <td>
                                                {{ order.get('product_code')?.value }}
                                            </td>
                                            <td>
                                                {{ order.get('qty')?.value }}
                                            </td>
                                            <td>
                                                <div>
                                                    <p class="m-0 p-0">{{ order.get('unit_measurement')?.value}} <sup>{{ order.get('unit_unit')?.value }}</sup> </p>
                                                </div>
                                            </td>
                                            <!-- <td>
                                                Rp. {{ order.get('price_list')?.value | number:'1.0-0' }}
                                            </td>
                                            <td>
                                                <ng-container *ngIf="order.get('discount_type')?.value === 'percent';else priceAdditional">
                                                    {{ order.get('discount')?.value }} %
                                                </ng-container>
                                                <ng-template #priceAdditional>
                                                    Rp. {{ order.get('discount_price')?.value | number:'1.0-0' }}
                                                </ng-template>
                                            </td> -->
                                            <td>
                                                <div style="margin-top: 4px;">
                                                    <p class="m-0 p-0">Rp. {{ order.get('total_cost')?.value | number:'1.0-0' }}</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </ng-container>
                                    <ng-container formArrayName="order_additional">
                                        <tr *ngFor="let order of orderAdditional.controls; let i = index" [formGroupName]="i">
                                            <td>
                                                {{ order.get('product_description')?.value }}
                                            </td>
                                            <td>-</td>
                                            <td>
                                                {{ order.get('qty')?.value }}
                                            </td>
                                            <td>
                                                <div>
                                                    <p class="m-0 p-0">{{ order.get('measurement')?.value}} <sup>{{ order.get('unit')?.value }}</sup> </p>
                                                </div>
                                            </td>
                                            <!-- <td>
                                                Rp. {{ order.get('price_list')?.value | number:'1.0-0' }}
                                            </td>
                                            <td>
                                                <ng-container *ngIf="order.get('discount_type')?.value === 'percent';else priceAdditional">
                                                    {{ order.get('discount')?.value }} %
                                                </ng-container>
                                                <ng-template #priceAdditional>
                                                    Rp. {{ order.get('discount_price')?.value | number:'1.0-0' }}
                                                </ng-template>
                                            </td> -->
                                            <td>
                                                <div style="margin-top: 4px;">
                                                    <p class="m-0 p-0">Rp. {{ order.get('total_cost')?.value | number:'1.0-0' }}</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </ng-container>
                                </tbody>
                            </table>
                        </div>

        
                        <div class="d-flex flex-row align-items-center justify-content-between gap-5">
                            <div class="w-100">
                                <div class="d-flex align-items-center justify-content-between" style="margin-bottom: 12px;">
                                    <p class="m-0 p-0 fw-semibold">Total Raw Materials</p>
                                    <p class="m-0 p-0 fw-semibold total-order">Rp {{ totalInventoryOrder | number:'1.0-0' }}</p>
                                </div>
            
                                <div class="d-flex align-items-center justify-content-between total-children">
                                    <p class="m-0 p-0 fw-semibold">Total Additional Cost</p>
                                    <p class="m-0 p-0 fw-semibold total-order">Rp {{ totalAdditionalOrder | number:'1.0-0' }}</p>
                                </div>
                            </div>
                            <div class="w-100">
                                <div class="d-flex align-items-center justify-content-between" style="margin-bottom: 12px;">
                                    <p class="m-0 p-0 fw-semibold">Total Order</p>
                                    <p class="m-0 p-0 fw-semibold total-order">Rp {{ totalOrder | number:'1.0-0' }}</p>
                                </div>
            
                                <div class="d-flex align-items-center justify-content-between total-children">
                                    <p class="m-0 p-0 fw-semibold">Grand Total</p>
                                    <p class="m-0 p-0 fw-semibold total-order">Rp {{ totalGrandOrder | number:'1.0-0' }}</p>
                                </div>
                            </div>     

                        </div>
                    </nz-tab>
                </nz-tabset>
            </div>
        </form>
    </div>

    <div class="footer">
        <div class="d-flex gap-2 justify-content-end">
            <button nz-button nzType="default" (click)="closeDrawer()">Cancel</button>
            <button nz-button nzType="primary" (click)="submitPurchase()" [disabled]="!assemblyForm.valid">{{ modal_type === 'add' || modal_type === 'duplicate' ? 'Submit' : 'Edit Inventory' }}</button>
        </div>
    </div>
</div>
